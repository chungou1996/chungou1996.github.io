---
layout: post
title: 电梯卡分析
---

某电梯发卡软件的分析

  今天朋友给我一个发卡软件，输入指定的过期日期后，软件会计算出一个校验码，连同过期日期写入IC卡，重点就是这个校验码如何产生的。

  随手查了一下壳，发现是VC编译的，开OD载入程序，导入库中出现一堆未知方法，来源是MFC42.lib，显然这是一个MFC程序，导入一下MFC库即可，不过我对MFC并不熟悉，按一般方法，先输入一个错误的日期试试，果然程序弹出了错误信息，这就好办了，在数据区搜索一下这个字符串，然后看一下哪里使用过。果然找到了，那么接下来向下观察，发现下面有个call很可疑，跟进去看一下，有个很独特的call，压入了%04X，虽然我对MFC不熟，这个显然是某种格式化语句，即以4位输出字节，不足四位以0补充。而我们的校验码刚好就是4位，那么关键算法必然就在这上面。果然在上面一个call发现了算法段，这里我写了一些注释方便看懂。
  x的低十六位的高八位其实就是32位寄存器EAX的16位寄存器AX的高八位AH，这个看起来很别扭，但是后面看起来没有使用过EAX，所以这里其实直接用U16代替就可以了。据此写出算法。这里用到了一个字典，不过我并不知道字典的长度，我猜测是200h，从开头复制200h到文件里，然后用的时候读取即可。
为了方便观察寄存器，这里直接用寄存器做变量名了，写完了试一下。